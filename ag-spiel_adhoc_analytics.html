<!DOCTYPE html>
<html>
  <head>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th, td {
        padding: 5px;
      }
      th {
        text-align: left;
      }
      td {
        text-align: right;
      }
      </style>
  </head>
<body>

<h2>AG-Spiel Ad-hoc Analytics</h2>

<p id="info">aktualisiere...</p>
<table>
  <tr>
    <th>Kennzahl</th>
    <th text->Wert</th>
  </tr>
  <tr>
    <td>AGs</td>
    <td id="count_ags">...</td>
  </tr>
  <tr>
    <td>Anzahl Orders in den letzten 24 Stunden</td>
    <td id="count_orders">...</td>
  </tr>
  <tr>
    <td>Ordervolumen in den letzten 24 Stunden</td>
    <td id="count_volumen">...</td>
  </tr>
  <tr>
    <td>Marktkapitalisierung</td>
    <td id="summe_marktkapitalisierung">...</td>
  </tr>
  <tr>
    <td>Bargeldbestände</td>
    <td id="summe_bargeld">...</td>
  </tr>
  <tr>
    <td>Gehaltende Anleihen</td>
    <td id="summe_anleihen">...</td>
  </tr>
  <tr>
    <td>Erwartete Zinserträge</td>
    <td id="summe_zinsertrag">...</td>
  </tr>
  <tr>
    <td>Fremdkapitaleinsatz</td>
    <td id="summe_kredite">...</td>
  </tr>
  <tr>
    <td>Fremdkapitalkosten</td>
    <td id="summe_zinsaufwand">...</td>
  </tr>
</table>

<h2>Anleihebuch der Systembank</h2>
<p id="info001">aktualisiere...</p>
<table>
  <tr>
    <th>Datum der Rückzahlung</th>
    <th>Tilgung</th>
    <th>Zinsen</th>
    <th>Gesamt</th>
  </tr>
  <tr>
    <td id="rep_001_0_d">...</td>
    <td id="rep_001_0_t">...</td>
    <td id="rep_001_0_z">...</td>
    <td id="rep_001_0_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_1_d">...</td>
    <td id="rep_001_1_t">...</td>
    <td id="rep_001_1_z">...</td>
    <td id="rep_001_1_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_2_d">...</td>
    <td id="rep_001_2_t">...</td>
    <td id="rep_001_2_z">...</td>
    <td id="rep_001_2_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_3_d">...</td>
    <td id="rep_001_3_t">...</td>
    <td id="rep_001_3_z">...</td>
    <td id="rep_001_3_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_4_d">...</td>
    <td id="rep_001_4_t">...</td>
    <td id="rep_001_4_z">...</td>
    <td id="rep_001_4_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_5_d">...</td>
    <td id="rep_001_5_t">...</td>
    <td id="rep_001_5_z">...</td>
    <td id="rep_001_5_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_6_d">...</td>
    <td id="rep_001_6_t">...</td>
    <td id="rep_001_6_z">...</td>
    <td id="rep_001_6_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_7_d">...</td>
    <td id="rep_001_7_t">...</td>
    <td id="rep_001_7_z">...</td>
    <td id="rep_001_7_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_8_d">...</td>
    <td id="rep_001_8_t">...</td>
    <td id="rep_001_8_z">...</td>
    <td id="rep_001_8_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_9_d">...</td>
    <td id="rep_001_9_t">...</td>
    <td id="rep_001_9_z">...</td>
    <td id="rep_001_9_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_10_d">...</td>
    <td id="rep_001_10_t">...</td>
    <td id="rep_001_10_z">...</td>
    <td id="rep_001_10_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_11_d">...</td>
    <td id="rep_001_11_t">...</td>
    <td id="rep_001_11_z">...</td>
    <td id="rep_001_11_g">...</td>
  </tr>
  <tr>
    <td id="rep_001_12_d">...</td>
    <td id="rep_001_12_t">...</td>
    <td id="rep_001_12_z">...</td>
    <td id="rep_001_12_g">...</td>
  </tr>
</table>

<h2>TOP 20 AGs with lowest Spreads</h2>
<p id="info002">aktualisiere...</p>
<p id="rep_002_low_spreads"></p>
<script>
    var xmlhttp = new XMLHttpRequest();
    var data;
    xmlhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        data = JSON.parse(this.responseText);
        document.getElementById("info").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
        document.getElementById("info001").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
        document.getElementById("info002").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
        document.getElementById("count_ags").innerHTML = data.allgemein.ags.toLocaleString('de');
        document.getElementById("count_orders").innerHTML = data.allgemein["24_stunden_orders"].toLocaleString('de');
        document.getElementById("count_volumen").innerHTML = data.allgemein["24_stunden_ordervolumen"].toLocaleString('de')+" €";
        var bargeld = 0;
        var marktkapitalisierung = 0;
        var anleihen = 0;
        var erw_zinsertrag = 0;
        var kredite = 0;
        var erw_zinsaufwand = 0;
        var ag;
        var bond;
        var loan;
        var anleihe_buch = {};
        var briefkurs;
        var geldkurs;
        var spreads = [];
        for (ag in data.ags){
          //console.log("wkn "+ag)
          marktkapitalisierung += data['ags'][ag]['aktienanzahl']*data['ags'][ag]['kurs']
          //console.log(marktkapitalisierung)
          bargeld += data['ags'][ag]['bargeld']
          //console.log(bargeld)
          //console.log(data['ags'][ag]['anleihen'])
          briefkurs = data['ags'][ag]['brief']
          geldkurs = data['ags'][ag]['geld']
          userprojekt = data['ags'][ag]['ceo']['ist_userprojekt_account']
          if (briefkurs != 0 && geldkurs != 0 && ! userprojekt){
            spreads.push([ag,data['ags'][ag]['name'],((briefkurs - geldkurs)*100/geldkurs).toFixed(5)]) 
          }


          for (bond in data['ags'][ag]['anleihen']){
            ////console.log([bond,isNaN(data['ags'][ag]['anleihen'][bond]['betrag']),isNaN(data['ags'][ag]['anleihen'][bond]['zins']),isNaN(data['ags'][ag]['anleihen'][bond]['laufzeit'])])
            betrag = data['ags'][ag]['anleihen'][bond]['betrag']
            zins = data['ags'][ag]['anleihen'][bond]['zins']
            laufzeit = data['ags'][ag]['anleihen'][bond]['laufzeit']
            
            anleihen += betrag
            anleihe_buch[ag+"_"+bond] = data['ags'][ag]['anleihen'][bond]
            
            zinsertrag = ((betrag*(1+zins/100)**laufzeit)-betrag)
            erw_zinsertrag += zinsertrag
            
          }
          //console.log(anleihen)
          //console.log(erw_zinsertrag)

          for (loan in data['ags'][ag]['kredite']){
            betrag = data['ags'][ag]['kredite'][loan]['betrag']
            zins = data['ags'][ag]['kredite'][loan]['zins']
            laufzeit = data['ags'][ag]['kredite'][loan]['laufzeit']
            
            kredite += betrag
            
            erw_zinsaufwand += ((betrag*(1+zins/100)**laufzeit)-betrag)
            
          }
          //console.log(kredite)
          //console.log(erw_zinsaufwand)


        }
        //console.log(anleihe_buch)
        document.getElementById("summe_bargeld").innerHTML = bargeld.toLocaleString('de')+" €";
        document.getElementById("summe_anleihen").innerHTML = anleihen.toLocaleString('de')+",00 €";
        document.getElementById("summe_zinsertrag").innerHTML = erw_zinsertrag.toLocaleString('de')+" €";
        document.getElementById("summe_kredite").innerHTML = kredite.toLocaleString('de')+",00 €";
        document.getElementById("summe_zinsaufwand").innerHTML = erw_zinsaufwand.toLocaleString('de')+" €";
        document.getElementById("summe_marktkapitalisierung").innerHTML = marktkapitalisierung.toLocaleString('de')+" €";
        var anleihe_report = {};
        var dates = [];
        var datum;
        for (bond in anleihe_buch){
          //console.log("cycle "+bond )
          datum = anleihe_buch[bond]['auszahlung_datum'].substring(0,10)

          betrag = anleihe_buch[bond]['betrag']
          zins = anleihe_buch[bond]['zins']
          laufzeit = anleihe_buch[bond]['laufzeit']
          zinsertrag = ((betrag*(1+zins/100)**laufzeit)-betrag)
          //console.log(datum)
          //console.log(betrag)
          //console.log(zinsertrag)
          //console.log(dates)
          if (dates.indexOf(datum) == -1){
            dates.push(datum)
            anleihe_report[datum] = [betrag, zinsertrag, betrag + zinsertrag]
          }
          else{
            //anleihe_report[datum] += [betrag, zinsertrag, betrag + zinsertrag]
            anleihe_report[datum] = anleihe_report[datum].map(function (num, idx) {
              return num + [betrag, zinsertrag, betrag + zinsertrag][idx]; 
            })
          }
                 
        }
        //console.log(anleihe_report) 
        for (date in dates.sort()){
          //console.log(date, dates[date],anleihe_report[dates[date]])
          document.getElementById("rep_001_"+date+"_d").innerHTML = dates[date]
          document.getElementById("rep_001_"+date+"_t").innerHTML = anleihe_report[dates[date]][0].toLocaleString('de')+" €";
          document.getElementById("rep_001_"+date+"_z").innerHTML = anleihe_report[dates[date]][1].toLocaleString('de')+" €";
          document.getElementById("rep_001_"+date+"_g").innerHTML = anleihe_report[dates[date]][2].toLocaleString('de')+" €";
          //console.log(dates[date])
          //console.log(anleihe_report[dates[date]])
        }
        document.getElementById("rep_001_12_d").innerHTML = "Total"
        document.getElementById("rep_001_12_t").innerHTML = anleihen.toLocaleString('de')+" €";
        document.getElementById("rep_001_12_z").innerHTML = erw_zinsertrag.toLocaleString('de')+" €";
        document.getElementById("rep_001_12_g").innerHTML = (anleihen + erw_zinsertrag).toLocaleString('de')+" €";
        //report Top 20 low spread
        spreads.sort(function(a, b){return a[2] - b[2]})
        var tmp_link;
        var text = "<table>";

        text += "<tr><th>WKN</th><th>Name</th><th>Spread in %</th></tr>"
          for (i = 0; i < 20; i++) {
            tmp_link = "https://www.ag-spiel.de/index.php?section=profil&aktie="+ spreads[i][0];
            text += "<tr><td> <a href="+tmp_link + "target='_blank'>"+spreads[i][0]+"</a></td><td> <a href="+tmp_link + "target='_blank'>"+spreads[i][1]+"</a></td><td> " + spreads[i][2] + "</td></tr>";
          }
          
          https://www.ag-spiel.de/index.php?section=profil&aktie=
          text += "</table>";
          
          document.getElementById("rep_002_low_spreads").innerHTML = text
      }
    };
    // FIXME request to Rady to include "Access-Control-Allow-Origin: *" in the response header
    xmlhttp.open("GET", "https://cors-anywhere.herokuapp.com/https://www.ag-spiel.de/api/get/data.php", true);
    xmlhttp.send();
    </script>

</html>
