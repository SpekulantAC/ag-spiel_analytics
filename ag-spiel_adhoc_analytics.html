<!DOCTYPE html>
<html>
   <head>
      <style>
         #customers {
         font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
         border-collapse: collapse;
         width: 100%;
         }
         td, th {
         border: 1px solid #ddd;
         padding: 8px;
         text-align: right;
         }
         tr:nth-child(even){background-color: #f2f2f2;}
         tr:hover {background-color: #ddd;}
         th {
         padding-top: 12px;
         padding-bottom: 12px;
         text-align: right;
         background-color: #4CAF50;
         color: white;
         }
         body {
         background-color: #FFFFFF;
         }
         h1 {
         color: rgb(0, 0, 0);
         text-align: center;
         }
         p {
         font-family: verdana;
         font-size: 20px;
         }
      </style>
   </head>
   <body>
      <h1>AG-Spiel Ad-hoc Analytics</h1>
      <h2>Marktüberblick</h2>
      <p id="info000">aktualisiere...</p>
      <p id="rep_000_markt"></p>
      <h2>Anleihebuch der Systembank</h2>
      <p id="info001">aktualisiere...</p>
      <p id="rep_001_anleihebuch"></p>
      <h2>TOP 20 AGs with lowest Spreads</h2>
      <p id="info002">aktualisiere...</p>
      <p id="rep_002_low_spreads"></p>
      <script>
         function currencyFormatDE(num) {
         return (
           num
             .toFixed(2) // always two decimal digits
             .replace('.', ',') // replace decimal point character with ,
             .replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.') + ' €'
         ) // use . as a separator
         };
         
         function report000_markt(data){
           //calcultate some figures
           var bargeld = 0;
           var marktkapitalisierung = 0;
           var anleihen = 0;
           var erw_zinsertrag = 0;
           var kredite = 0;
           var erw_zinsaufwand = 0;
           var ag;
           var bond;
           var loan;
           for (ag in data.ags){
                 //console.log("wkn "+ag)
                 marktkapitalisierung += data['ags'][ag]['aktienanzahl']*data['ags'][ag]['kurs']
                 //console.log(marktkapitalisierung)
                 bargeld += data['ags'][ag]['bargeld']
         
                 for (bond in data['ags'][ag]['anleihen']){
                   ////console.log([bond,isNaN(data['ags'][ag]['anleihen'][bond]['betrag']),isNaN(data['ags'][ag]['anleihen'][bond]['zins']),isNaN(data['ags'][ag]['anleihen'][bond]['laufzeit'])])
                   betrag = data['ags'][ag]['anleihen'][bond]['betrag']
                   zins = data['ags'][ag]['anleihen'][bond]['zins']
                   laufzeit = data['ags'][ag]['anleihen'][bond]['laufzeit']
                   
                   anleihen += betrag
         //            anleihe_buch[ag+"_"+bond] = data['ags'][ag]['anleihen'][bond]
                   
                   zinsertrag = ((betrag*(1+zins/100)**laufzeit)-betrag)
                   erw_zinsertrag += zinsertrag
                   
                 }
                 //console.log(anleihen)
                 //console.log(erw_zinsertrag)
         
                 for (loan in data['ags'][ag]['kredite']){
                   betrag = data['ags'][ag]['kredite'][loan]['betrag']
                   zins = data['ags'][ag]['kredite'][loan]['zins']
                   laufzeit = data['ags'][ag]['kredite'][loan]['laufzeit']
                   
                   kredite += betrag
                   
                   erw_zinsaufwand += ((betrag*(1+zins/100)**laufzeit)-betrag)
                   
                 }
           };
         
           //generate output table
           var txt_rep000;
           txt_rep000  = "<table><tr><th>Kennzahl</th><th >Wert</th></tr>";
           txt_rep000 += "<tr><td>AGs</td><td>" + data.allgemein.ags.toLocaleString('de') + "</td></tr>";
           txt_rep000 += "<tr><td>Anzahl Orders in den letzten 24 Stunden</td><td>" + data.allgemein["24_stunden_orders"].toLocaleString('de') + "</td></tr>";
           txt_rep000 += "<tr><td>Ordervolumen in den letzten 24 Stunden</td><td>" + currencyFormatDE(data.allgemein["24_stunden_ordervolumen"]) + "</td></tr>";
           txt_rep000 += "<tr><td>Marktkapitalisierung</td><td>" + currencyFormatDE(marktkapitalisierung) + "</td></tr>";
           txt_rep000 += "<tr><td>Bargeldbestände</td><td>" + currencyFormatDE(bargeld) + "</td></tr>";
           txt_rep000 += "<tr><td>Gehaltende Anleihen</td><td>" + currencyFormatDE(anleihen)+ "</td></tr>";
           txt_rep000 += "<tr><td>Erwartete Zinserträge</td><td>" + currencyFormatDE(erw_zinsertrag) + "</td></tr>";
           txt_rep000 += "<tr><td>Fremdkapitaleinsatz</td><td>" + currencyFormatDE(kredite) + "</td></tr>";
           txt_rep000 += "<tr><td>Fremdkapitalkosten</td><td>" + currencyFormatDE(erw_zinsaufwand) + "</td></tr>";
           txt_rep000 += "</table>";
           document.getElementById("info000").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
           document.getElementById("rep_000_markt").innerHTML = txt_rep000;
         };
         
         function report001_anleihebuch(data){
           var anleihen = 0;
           var erw_zinsertrag = 0;
           var kredite = 0;
           var erw_zinsaufwand = 0;
           var ag;
           var bond;
           var loan;
           var anleihe_buch = {};
           var anleihe_report = {};
           var dates = [];
           var datum;
           for (ag in data.ags){
             
             for (bond in data['ags'][ag]['anleihen']){
               anleihe_buch[ag+"_"+bond] = data['ags'][ag]['anleihen'][bond]  
             }
           }
           for (bond in anleihe_buch){
             //console.log("cycle "+bond )
             datum = anleihe_buch[bond]['auszahlung_datum'].substring(0,10)
         
             betrag = anleihe_buch[bond]['betrag']
             zins = anleihe_buch[bond]['zins']
             laufzeit = anleihe_buch[bond]['laufzeit']
             zinsertrag = ((betrag*(1+zins/100)**laufzeit)-betrag)
             anleihen += betrag
             erw_zinsertrag += zinsertrag
             if (dates.indexOf(datum) == -1){
               dates.push(datum)
               anleihe_report[datum] = [betrag, zinsertrag, betrag + zinsertrag]
             }
             else{
               //anleihe_report[datum] += [betrag, zinsertrag, betrag + zinsertrag]
               anleihe_report[datum] = anleihe_report[datum].map(function (num, idx) {
                 return num + [betrag, zinsertrag, betrag + zinsertrag][idx]; 
               })
             }
                     
           }
           //console.log(anleihe_report)
           var txt_rep001;
           txt_rep001 = "<table>"
           txt_rep001 += "<tr><th>Datum der Rückzahlung</th><th>Tilgung</th><th>Zinsen</th><th>Gesamt</th></tr>" 
           for (date in dates.sort()){
             //console.log(date, dates[date],anleihe_report[dates[date]])
             txt_rep001 += "<tr><td>"+dates[date]+"</td><td>"+
               currencyFormatDE(anleihe_report[dates[date]][0]) + "</td><td>" +
               currencyFormatDE(anleihe_report[dates[date]][1]) + "</td><td>" +
               currencyFormatDE(anleihe_report[dates[date]][2]) + "</td></tr>"
             //console.log(dates[date])
             //console.log(anleihe_report[dates[date]])
           }
           txt_rep001 += "<tr><th>Total</th><th>" +
             currencyFormatDE(anleihen) + "</th><th>" +
             currencyFormatDE(erw_zinsertrag) + "</th><th>" +
             currencyFormatDE(anleihen + erw_zinsertrag) + "</th></tr></table>"
             
           document.getElementById("info001").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
           document.getElementById("rep_001_anleihebuch").innerHTML = txt_rep001
         
         };
         
         function report002_low_spreads(data){
         var briefkurs;
               var geldkurs;
               var spreads = [];
               for (ag in data.ags){
                 briefkurs = data['ags'][ag]['brief']
                 geldkurs = data['ags'][ag]['geld']
                 userprojekt = data['ags'][ag]['ceo']['ist_userprojekt_account']
                 if (briefkurs != 0 && geldkurs != 0 && ! userprojekt){
                   spreads.push([ag,data['ags'][ag]['name'],((briefkurs - geldkurs)*100/geldkurs).toFixed(5)]) 
                 }
               }
               spreads.sort(function(a, b){return a[2] - b[2]})
               var tmp_link;
               var text = "<table>";
         
               text += "<tr><th>Platz</th><th>WKN</th><th>Name</th><th>Spread in %</th></tr>"
                 for (i = 0; i < 20; i++) {
                   tmp_link = "https://www.ag-spiel.de/index.php?section=profil&aktie="+ spreads[i][0];
                   text += "<tr><td>"+ (i+1) + "</td><td> <a href="+tmp_link + "target='_blank'>"+spreads[i][0]+"</a></td><td> <a href="+tmp_link + "target='_blank'>"+spreads[i][1]+"</a></td><td> " + spreads[i][2] + "</td></tr>";
                 }
                 text += "</table>";
                 document.getElementById("info002").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
                 document.getElementById("rep_002_low_spreads").innerHTML = text
         };
         
         var xmlhttp = new XMLHttpRequest();
           var data;
           xmlhttp.onreadystatechange = function() {
             if (this.readyState == 4 && this.status == 200) {
               data = JSON.parse(this.responseText);
               //return data;
               report000_markt(data);
               report001_anleihebuch(data);
               report002_low_spreads(data)
             }
           };
           // FIXME request to Rady to include "Access-Control-Allow-Origin: *" in the response header
           xmlhttp.open("GET", "https://cors-anywhere.herokuapp.com/https://www.ag-spiel.de/api/get/data.php", true);
           xmlhttp.send();
           
           
      </script>
   </body>
</html>
