<!DOCTYPE html>
<html>
  <head>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th, td {
        padding: 5px;
      }
      th {
        text-align: left;
      }
      td {
        text-align: right;
      }
      </style>
  </head>
<body>

<h2>AG-Spiel Ad-hoc Analytics</h2>

<p id="info">aktualisiere...</p>
<table>
  <tr>
    <th>Kennzahl</th>
    <th text->Wert</th>
  </tr>
  <tr>
    <td>AGs</td>
    <td id="count_ags">...</td>
  </tr>
  <tr>
    <td>Anzahl Orders in den letzten 24 Stunden</td>
    <td id="count_orders">...</td>
  </tr>
  <tr>
    <td>Ordervolumen in den letzten 24 Stunden</td>
    <td id="count_volumen">...</td>
  </tr>
  <tr>
    <td>Marktkapitalisierung</td>
    <td id="summe_marktkapitalisierung">...</td>
  </tr>
  <tr>
    <td>Bargeldbestände</td>
    <td id="summe_bargeld">...</td>
  </tr>
  <tr>
    <td>Gehaltende Anleihen</td>
    <td id="summe_anleihen">...</td>
  </tr>
  <tr>
    <td>Erwartete Zinserträge</td>
    <td id="summe_zinsertrag">...</td>
  </tr>
  <tr>
    <td>Fremdkapitaleinsatz</td>
    <td id="summe_kredite">...</td>
  </tr>
  <tr>
    <td>Fremdkapitalkosten</td>
    <td id="summe_zinsaufwand">...</td>
  </tr>
</table>

<script>
    var xmlhttp = new XMLHttpRequest();
    
    xmlhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        data = JSON.parse(this.responseText);
        document.getElementById("info").innerHTML = "Zuletzt aktualisiert: " + data.daten_datum;
        document.getElementById("count_ags").innerHTML = data.allgemein.ags.toLocaleString('de');
        document.getElementById("count_orders").innerHTML = data.allgemein["24_stunden_orders"].toLocaleString('de');
        document.getElementById("count_volumen").innerHTML = data.allgemein["24_stunden_ordervolumen"].toLocaleString('de')+" €";
        var bargeld = 0;
        var marktkapitalisierung = 0;
        var anleihen = 0;
        var erw_zinsertrag = 0;
        var kredite = 0;
        var erw_zinsaufwand = 0;
        var ag;
        var bond;
        var loan;
        for (ag in data.ags){
          console.log("wkn "+ag)
          marktkapitalisierung += data['ags'][ag]['aktienanzahl']*data['ags'][ag]['kurs']
          console.log(marktkapitalisierung)
          bargeld += data['ags'][ag]['bargeld']
          console.log(bargeld)
          console.log(data['ags'][ag]['anleihen'])

          for (bond in data['ags'][ag]['anleihen']){
            //console.log([bond,isNaN(data['ags'][ag]['anleihen'][bond]['betrag']),isNaN(data['ags'][ag]['anleihen'][bond]['zins']),isNaN(data['ags'][ag]['anleihen'][bond]['laufzeit'])])
            betrag = data['ags'][ag]['anleihen'][bond]['betrag']
            zins = data['ags'][ag]['anleihen'][bond]['zins']
            laufzeit = data['ags'][ag]['anleihen'][bond]['laufzeit']
            
            anleihen += betrag
            
            
            zinsertrag = ((betrag*(1+zins/100)**laufzeit)-betrag)
            erw_zinsertrag += zinsertrag
            
          }
          console.log(anleihen)
          console.log(erw_zinsertrag)

          for (loan in data['ags'][ag]['kredite']){
            betrag = data['ags'][ag]['kredite'][loan]['betrag']
            zins = data['ags'][ag]['kredite'][loan]['zins']
            laufzeit = data['ags'][ag]['kredite'][loan]['laufzeit']
            
            kredite += betrag
            
            erw_zinsaufwand += ((betrag*(1+zins/100)**laufzeit)-betrag)
            
          }
          console.log(kredite)
          console.log(erw_zinsaufwand)


        }
        document.getElementById("summe_bargeld").innerHTML = bargeld.toLocaleString('de')+" €";
        document.getElementById("summe_anleihen").innerHTML = anleihen.toLocaleString('de')+",00 €";
        document.getElementById("summe_zinsertrag").innerHTML = erw_zinsertrag.toLocaleString('de')+" €";
        document.getElementById("summe_kredite").innerHTML = kredite.toLocaleString('de')+",00 €";
        document.getElementById("summe_zinsaufwand").innerHTML = erw_zinsaufwand.toLocaleString('de')+" €";
        document.getElementById("summe_marktkapitalisierung").innerHTML = marktkapitalisierung.toLocaleString('de')+" €";

      }
    };
    // FIXME request to Rady to include "Access-Control-Allow-Origin: *" in the response header
    xmlhttp.open("GET", "https://cors-anywhere.herokuapp.com/https://www.ag-spiel.de/api/get/data.php", true);
    xmlhttp.send();
    </script>

</html>
